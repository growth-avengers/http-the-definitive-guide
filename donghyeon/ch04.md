# ch04. 커넥션 관리

- TCP 커넥션
	- 클라이언트와 서버간에 주고받는 메시지는 손실되거나 순서가 바뀌지 않음
	- TCP는 세그먼트 단위로 데이터 스트림을 나누고, 이를 IP 패킷에 담아 데이터를 전달한다.
		- IP 패킷
			- IP 패킷 헤더
				- 보통 20byte
				- 발신지 IP, 목적지 IP, 크기, 기타 플래그
			- TCP 세그먼트 헤더
				- 보통 20byte
				- TCP 포트 번호, TCP 제어 플래그, 데이터 순서, 무결성 검사용 숫자
			- TCP 데이터 조각
	- TCP 커넥션의 '발신지 IP, 발신지 PORT, 수신지 IP, 수신지 PORT' 조합은 중복될 수 없음
- TCP 성능 저하
	- 대부분의 HTTP 트랜잭션 지연은 TCP 네트워크 지연이 원인
	- TCP 네트워크 지연은 H/W 성능, 네트워크와 서버의 전송 속도, 메시지 크기 등 다양한 원인으로 발생
	- 대표적인 지연의 종류
		- TCP 커넥션 핸드셰이크 지연
			- 보통 SYN, SYN+ACK 핸드 셰이크가 눈에 띄는 지연을 발생시킴
		- 확인응답 지연 알고리즘
			- TCP 세그먼트를 온전히 받으면 확인응답 패킷을 송신자에게 반환
			- 확인응답 패킷은 크기가 작기 때문에 따로 보내지 않고 같은 방향으로 송출되는 패킷에 편승(piggyback)시킴
			- 편승되는 경우를 늘리기 위해 확인응답 지연 알고리즘 사용
			- HTTP 동작은 요청, 응답 두 가지 형식으로만 이루어져 있어서 편승할 기회가 적기때문에 지연 발생
		- TCP의 slow-start
			- 커넥션 초기에는 인터넷의 급작스러운 부하 방지를 위해 한 번에 전송할 수 있는 패킷의 수를 제한
			- 확인응답을 받은 패킷은 받은 패킷의 2배의 패킷을 보낼 수 있음
				- 1개 -> 2개 -> 4개
		- Nagle 알고리즘
			- TCP 세그먼트는 약 40바이트의 플래그와 헤더를 포함하기 때문에 작은 데이터를 많이 보내면 성능이 크게 떨어짐
			- 네이글 알고리즘은 패킷을 전송하기 전에 많은 양의 TCP 데이터를 한 개의 덩어리로 합침
			- 네이글 알고리즘은 세그먼트가 최대 크기가 되지 않으면 전송을 하지 않음.
			- 단, 다른 모든 패킷이 확인응답을 받았으면 작은 패킷도 전송
		- TIME_WAIT 지연과 포트 고갈
			- 보통은 발생하지 않는 문제
			- TCP 커넥션을 끊으면, TCP 커넥션의 종단에서는 커넥션의 IP, PORT 정보를 메모리의 제어영역(control block)에 기록
				- 같은 주소, 포트를 사용하는 커넥션이 일정시간동안 생성되는 것을 방지
			- 보통 이 기록은 2분(세크먼트의 최대 생명 주기의 2배, '2MSL')정도 유지
			- 만약에 포트의 수가 60,000개로 제한 되어 있고 2MSL초 동안 커넥션을 사용할 수 없다면 초당 500개(60,000 / 120)로 커넥션이 제한됨
- HTTP 커넥션 관리
	- 적은 수의 병렬 커넥션 + 지속 커넥션
	- 병렬 커넥션
		- 항상 더 빠르지는 않지만 사용자는 더 빠르게 느낄 수 있음
		- 단점
			- 각 트랜잭션마다 커넥션을 연결,해제하기 때문에 시간과 대역폭이 소요
			- 각각의 새로운 커넥션은 TCP의 느린 시작으로 인해 성능이 떨어짐
			- 실제 연결 가능한 병렬 커넥션의 수는 제한이 있음
	- 지속 커넥션
		- 사이트 지역성(site locality): HTTP 요청을 시작한 애플리케이션은 또 요청을 할 것
		- 처리가 완료된 후에도 TCP 커넥션을 유지
		- 종류
			- HTTP/1.0+의 Keep-Alive 커넥션
				- 멍청한 프록시 때문에 문제가 발생할 수 있음
			- HTTP/1.1의 지속 커넥션
