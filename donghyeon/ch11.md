# ch11. 클라이언트 식별과 쿠키

- 웹 서버는 클라이언트를 식별하거나 연속적인 요청을 추적하기 위해 약간의 정보를 이용
  - 더 나아가 사이트를 개인화시켜 제공할 수 있음
    - 개별 인사: 사용자에게 특화된 환영 메시지
    - 사용자 맞춤 추천: 고객의 흥미를 학습해서 제품 추천
    - 저장된 사용자 정보: 사용자의 주소, 신용카드 등을 저장해 매번 입력하지 않아도 되도록 함
    - 세션 추적: HTTP 트랜잭션을 식별하는 방법
- HTTP가 사용자를 식별하는데 사용하는 기술
  - HTTP 헤더
    - From: 요청 헤더. 사용자의 이메일 주소
    - User-Agent: 요청 헤더. 사용자의 브라우저
    - Referer: 요청 헤더. 사용자가 현재 링크를 타고 온 근원 페이지
    - Authorization: 요청 헤더. 사용자 이름과 비밀번호
    - Client-ip: 확장 요청 헤더. 클라이언트의 IP 주소
    - X-Forwarded-For: 확장 요청 헤더. 클라이언트의 IP 주소
    - Cookie: 확장 요쳥 헤더. 서버가 생성한 ID 라벨
  - 클라이언트 IP 주소 추적(Client-ip 헤더를 기술하는 프락시가 있지만 이는 HTTP 표준이 아님)
    - UNIX 시스템에서 `getpeername` 함수를 호출하면 클라이언트의 IP 주소를 받을 수 있음
    - 문제점(약점)
      - IP 주소는 사용자가 아닌, 사용하는 컴퓨터
      - 많은 ISP(Internet Service Provider)는 사용자가 로그인하면 동적으로 IP 주소를 할당
      - 많은 사용자가 NAT(Network Address Translation) 방화벽을 통해 인터넷을 사용
        - 보안 강화, 부족한 주소 관리 목적
        - NAT 장비들은 클라이언트의 실제 IP 주소를 방화벽 뒤로 숨김
        - 클라이언트의 실제 IP 주소를 내부에서 사용하는 하나의 방화벽 IP 주소(+ 다른 포트번호)로 변환
      - HTTP 프락시, 게이트웨이는 원 서버와 새로운 TCP 연결을 하므로 웹 서버는 프락시 서버의 IP를 받을 수 있음
        - Client-ip나 X-Forwarded-For 확장 헤더를 통해 문제를 해결
  - 사용자 로그인 인증
    - 사용자에게 명시적으로 식별 요청
    - 웹 사이트 로그인이 더 쉽도록 WWW-Authenticate(로그인 해라!!)와 Authorization(사용자 정보) 헤더를 지원
    - 모든 요청에 위의 헤더들을 같이 보내므로 웹 서버는 로그인 정보를 항상 확인할 수 있음
  - Fat URL
    - 사용자의 URL마다 버전을 기술해 사용자 식별 및 추적
    - 사용자가 웹 사이트에 처음 방문하면 웹 서버는 식별 ID가 생성, URL에 추가한 뒤 클라이언트를 Fat URL로 리다이렉트 시킴
    - 문제점
      - 못생긴 URL
      - 공유하지 못하는 URL
      - 캐시를 사용할 수 없음: URL이 달라지기 때문에 기존 캐시에 접근할 수 없음
      - 서버 부하 가중: 서버는 뚱뚱한 URL에 해당하는 HTML 페이지를 다시 그려야함
      - 이탈: 사용자가 링크를 타고 이동하거나 특정 URL을 요청해서 의도치 않게 Fat URL 세션에서 이탈할 수 있음
      - 세션 간 지속성의 부재: 사용자가 Fat URL을 북마크하지 않는 이상 로그아웃하면 모든 정보를 잃음
  - 쿠키
    - 사용자 식별 및 세션 유지 방식 중 가장 널리 사용
    - 캐시와 충돌할 수 있어서 대부분의 캐시나 브라우저는 쿠키 내용을 캐싱하지 않음
    - 쿠키 타입
      - 세션 쿠키(session cookie)
        - 사용자가 사이트를 탐색할 때 저장, 사용하는 임시 쿠키
        - 브라우저를 닫으면 삭제됨
      - 지속 쿠키(persistent cookie)
        - 디스크에 저장되어 컴퓨터를 재시작해도 남아있음
        - 사용자가 주기적으로 방문하는 사이트에 대한 설정, 로그인 이름을 유지
      - 차이점
        - 쿠키 파기 시점만 다름
        - Discard(현재 세션에만 유지하도록 설정) 파라미터가 설정되어 있거나, Expires 또는 Max-age 파라미터가 없으면 세션 쿠키
    - 쿠키의 동작 방식
      - 쿠키는 key=value 형태의 리스트를 가짐
      - Set-Cookie 혹는 Set-Cookie2(확장 헤더) 같은 응답 헤더에 쿠키를 기술
      - 브라우저는 Set-Cookie 혹는 Set-Cookie2(확장 헤더)에 있는 쿠키를 브라우저 쿠키 DB에 저장
      - 브라우저는 쿠키를 Cookie 요청 헤더에 기술해 서버에 전송
    - Set-Cookie 헤더의 속성
      - Version 0, Version 1이 있지만 Version 1은 거의 사용되지 않음
      - Version 0 쿠키 명세
        - Key=Value: 필수 속성. key, value 모두 따옴표로 감싸지 않은 세미콜론, 쉼포, 등호, 공백을 포함하지 않는 문자열
        - Expires: 선택 속성. 쿠키 만료일자. 사용할 수 있는 타임 존은 GMT. Expries를 명시하지 않으면 세션 쿠키
        - Domain: 선택 속성. 서버가 쿠키 생성시 어떤 사이트가 그 쿠키를 읽을 수 있는지 기술
        - Path: 선택 속성. 웹 사이트 일부 경로(Path)에만 쿠키를 적용
        - Secure: 선택 속성. 이 속성이 있으면 HTTP가 SSL 보안 연결을 사용할 때만 쿠키 전송
